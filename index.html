<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ğŸ“… ì¼ì • ê´€ë¦¬ ì•±</title>
<style>
:root {
  --bg-main: #f0f2f5;
  --bg-light: #fff;
  --text-main: #333;
  --text-light: #666;
  --border-color: #eee;
  --header-bg: #4a90e2;
  --header-text: #fff;
}
body.dark-mode {
  --bg-main: #1a1a1a;
  --bg-light: #2a2a2a;
  --text-main: #e0e0e0;
  --text-light: #aaa;
  --border-color: #444;
  --header-bg: #3567b5;
  --header-text: #e0e0e0;
}
body {
  font-family:'Segoe UI', sans-serif;
  background: var(--bg-main);
  color: var(--text-main);
  margin:0;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  touch-action:manipulation;
  transition: background 0.3s, color 0.3s;
}
@media(max-width:1024px){
  body { align-items:flex-start; padding-top:0; }
  .calendar-container { width:100%; height:100vh; border-radius:0; }
}
@media(max-width:768px){
  .calendar-container { width:100%; height:100vh; border-radius:0; flex-direction:column; }
  .calendar-header { padding:12px 16px; }
  .calendar-header h2 { font-size:18px; }
  .header-buttons { gap:4px; }
  .header-buttons button { font-size:12px; padding:0 8px; height:28px; }
  .today-sidebar { display:none; }
  .calendar-content { flex-direction:column; }
  .resizer { display:none; }
}
@media(max-width:768px) and (orientation:portrait){
  .calendar-container { flex-direction:column; height:auto; min-height:100vh; }
  .calendar-content { flex-direction:column; height:auto; }
  .calendar-main { flex:0 0 auto; height:auto; min-height:400px; }
  .today-sidebar { display:flex; width:100%; height:auto; border-left:none; border-top:1px solid var(--border-color); max-height:none; flex:1; }
  .resizer { display:none; }
  .calendar-grid { position:relative; top:auto; left:auto; }
}
.calendar-container {
  width:1300px;
  height:650px;
  background: var(--bg-light);
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,0.15);
  position:relative;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
.calendar-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:16px 24px;
  background: var(--header-bg);
  color: var(--header-text);
  z-index:10;
  border-top-left-radius:16px;
  border-top-right-radius:16px;
  gap:20px;
}
.calendar-header h2 {
  margin:0;
  font-size:20px;
  font-weight:600;
  flex:0 0 auto;
}
.calendar-header .date-time {
  margin-left:auto;
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  font-size:12px;
}
.calendar-header .date-time .time {
  font-size:18px;
  font-weight:bold;
}
.calendar-content {
  display:flex;
  flex:1;
  position:relative;
  overflow:hidden;
}
.calendar-main {
  flex:1;
  position:relative;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  min-width:400px;
}
.calendar-grid {
  display:grid;
  grid-template-columns:repeat(7,1fr);
  grid-template-rows:40px repeat(6,1fr);
  flex:1;
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  transition:left 0.35s ease-out;
}
.day-header {
  text-align:center;
  font-weight:bold;
  color: var(--text-light);
  line-height:40px;
  border-bottom:1px solid var(--border-color);
}
.day {
  border:1px solid var(--border-color);
  background: var(--bg-light);
  position:relative;
  padding:6px;
  cursor:pointer;
  transition:background 0.2s;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  align-items:flex-start;
}
.day:hover { opacity: 0.7; }
.day-number {
  font-size:14px;
  color: var(--text-main);
  font-weight:bold;
}
.today {
  background:#ffefef !important;
  border:2px solid #ff6b6b !important;
}
.day.other { opacity:0.4; }
.dots {
  position:absolute;
  top:6px;
  right:6px;
  display:flex;
  gap:3px;
  flex-wrap:wrap;
}
.dot {
  width:14px;
  height:14px;
  border-radius:50%;
  cursor:pointer;
  flex-shrink:0;
}
.today-sidebar {
  width:320px;
  background: var(--bg-light);
  border-left:1px solid var(--border-color);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
.today-header {
  padding:16px;
  background: var(--header-bg);
  color: var(--header-text);
  text-align:center;
}
.today-header h3 {
  margin:0 0 4px 0;
  font-size:16px;
  font-weight:600;
}
.today-date {
  font-size:13px;
  opacity:0.9;
}
.today-events {
  flex:1;
  overflow-y:auto;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.today-event-item {
  padding:10px;
  background: var(--bg-main);
  border-radius:8px;
  border-left:4px solid var(--header-bg);
  display:flex;
  align-items:flex-start;
  gap:8px;
  font-size:13px;
  box-shadow:0 2px 4px rgba(0,0,0,0.05);
}
.today-event-checkbox {
  width:16px;
  height:16px;
  cursor:pointer;
  accent-color: var(--header-bg);
  margin-top:2px;
  flex-shrink:0;
}
.today-event-text {
  flex:1;
  word-break:break-word;
}
.today-event-text.completed {
  text-decoration:line-through;
  color: var(--text-light);
}
.today-event-dot {
  width:12px;
  height:12px;
  border-radius:50%;
  flex-shrink:0;
}
.today-empty {
  text-align:center;
  color: var(--text-light);
  padding:20px 10px;
  font-size:14px;
  margin:auto;
}
.popup, .view-popup, .edit-popup {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background: var(--bg-light);
  padding:20px;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,0.25);
  width:90%;
  max-width:360px;
  display:none;
  flex-direction:column;
  gap:12px;
  z-index:100;
  color: var(--text-main);
}
.popup h3, .view-popup h3, .edit-popup h3 {
  margin:0 0 10px 0;
  font-size:18px;
  text-align:center;
}
.color-picker {
  display:flex;
  gap:12px;
  justify-content:center;
  flex-wrap:wrap;
}
.color-option {
  width:28px;
  height:28px;
  border-radius:50%;
  cursor:pointer;
  border:2px solid transparent;
  transition: transform 0.2s, border 0.2s;
}
.color-option:hover {
  transform:scale(1.2);
  border:2px solid #333;
}
.popup input, .edit-popup input {
  padding:10px;
  font-size:14px;
  border-radius:10px;
  border:1px solid var(--border-color);
  width:100%;
  box-sizing:border-box;
  background: var(--bg-light);
  color: var(--text-main);
}
.popup button, .view-popup button, .edit-popup button {
  padding:10px;
  border:none;
  background: var(--header-bg);
  color: var(--header-text);
  border-radius:10px;
  cursor:pointer;
  transition: background 0.2s;
  font-size:14px;
}
.popup button:hover, .view-popup button:hover, .edit-popup button:hover { background:#357abd; }
.button-group {
  display:flex;
  gap:8px;
}
.button-group button {
  flex:1;
}
.cancel-btn {
  background:#999 !important;
}
.cancel-btn:hover {
  background:#777 !important;
}
.overlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.4);
  display:none;
  z-index:50;
}
.view-list {
  max-height:250px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.view-item {
  display:flex;
  align-items:center;
  gap:10px;
  padding:8px 10px;
  border-radius:10px;
  background: var(--bg-main);
  transition:background 0.2s;
  font-size:13px;
}
.view-item:hover { opacity:0.8; }
.view-item .view-dot {
  width:14px;
  height:14px;
  border-radius:50%;
  flex-shrink:0;
}
.view-item .view-text {
  flex-grow:1;
  word-break:break-word;
}
.view-item button {
  padding:4px 8px;
  font-size:12px;
  width:auto;
}
.header-buttons {
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}
.header-buttons button {
  background:rgba(255,255,255,0.2);
  border:none;
  color: var(--header-text);
  font-size:14px;
  height:32px;
  border-radius:8px;
  cursor:pointer;
  transition: background 0.2s;
  padding:0 12px;
  flex-shrink:0;
}
.header-buttons button:hover {
  background: rgba(255,255,255,0.35);
}
.legend {
  display:flex;
  flex-direction:column;
  gap:12px;
  align-items:flex-start;
  padding:12px 16px;
  background: var(--bg-light);
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.05);
}
.legend-item {
  display:flex;
  align-items:center;
  gap:8px;
  font-size:13px;
  color: var(--text-main);
}
.legend-item input[type="checkbox"] {
  cursor:pointer;
  width:16px;
  height:16px;
}
.legend-dot {
  width:20px;
  height:20px;
  border-radius:50%;
  flex-shrink:0;
}
.category-name {
  font-weight:500;
}
.stats-popup {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background: var(--bg-light);
  padding:24px;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,0.25);
  width:90%;
  max-width:400px;
  max-height:80vh;
  overflow-y:auto;
  display:none;
  flex-direction:column;
  gap:16px;
  z-index:100;
  color: var(--text-main);
}
.stats-popup h3 {
  margin:0;
  font-size:20px;
  text-align:center;
}
.stats-item {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  background: var(--bg-main);
  border-radius:8px;
  font-size:14px;
}
.stats-item .label {
  font-weight:600;
}
.stats-item .value {
  color: var(--header-bg);
  font-weight:bold;
  font-size:16px;
}
.search-box {
  padding:10px;
  border-radius:8px;
  border:1px solid var(--border-color);
  width:100%;
  box-sizing:border-box;
  background: var(--bg-light);
  color: var(--text-main);
  font-size:14px;
  margin-bottom:12px;
}
.search-results {
  max-height:300px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.search-result-item {
  padding:10px;
  background: var(--bg-main);
  border-left:4px solid var(--header-bg);
  border-radius:4px;
  font-size:13px;
  cursor:pointer;
}
.search-result-item:hover {
  background:var(--border-color);
}
.repeat-option {
  display:flex;
  align-items:center;
  gap:8px;
  margin:8px 0;
  font-size:13px;
}
.repeat-option input[type="radio"] {
  cursor:pointer;
}
.repeat-options-box {
  display:none;
  margin-top:8px;
  padding:10px;
  background: var(--bg-main);
  border-radius:8px;
}
.resizer {
  width:12px;
  cursor:col-resize;
  background:linear-gradient(90deg, rgba(0,0,0,0.03) 0%, rgba(0,0,0,0.06) 50%, rgba(0,0,0,0.03) 100%);
  flex:0 0 12px;
  touch-action:none;
}
.resizer:hover { background:linear-gradient(90deg, rgba(0,0,0,0.06) 0%, rgba(0,0,0,0.12) 50%, rgba(0,0,0,0.06) 100%); }
.resizer.active { background:linear-gradient(90deg, rgba(74,144,226,0.15) 0%, rgba(74,144,226,0.25) 50%, rgba(74,144,226,0.15) 100%); }
.carryover-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:6px 4px;
  border-bottom:1px solid var(--border-color);
  gap:8px;
}
.carryover-header > div {
  font-size:14px;
  font-weight:600;
}
.carryover-header button {
  padding:6px 8px;
  font-size:12px;
  border-radius:8px;
  background: var(--bg-light);
  border:1px solid var(--border-color);
  cursor:pointer;
}
.day.completed-day {
  background:#f0ffe6 !important;
  border:2px solid #2ed573 !important;
}
.confetti {
  position:fixed;
  width:10px;
  height:10px;
  background:gold;
  pointer-events:none;
  z-index:999;
  display:none;
}
</style>
</head>
<body>

<div class="calendar-container" id="calendarContainer"></div>
<div class="overlay" id="overlay"></div>

<div class="popup" id="popup">
  <h3>ì¼ì • ì¶”ê°€</h3>
  <input type="text" id="eventInput" placeholder="ì¼ì • ë‚´ìš© ì…ë ¥">
  <div class="color-picker" id="colorPicker"></div>
  <div style="display:flex;justify-content:center;gap:8px;align-items:center;">
    <label style="font-size:13px;color: var(--text-main);">ìš°ì„ ìˆœìœ„</label>
    <select id="prioritySelect" style="padding:6px;border-radius:8px;border:1px solid var(--border-color); background: var(--bg-light); color: var(--text-main);">
      <option value="high">ë†’ìŒ</option>
      <option value="medium" selected>ë³´í†µ</option>
      <option value="low">ë‚®ìŒ</option>
    </select>
  </div>
  <div style="font-size:12px;color: var(--text-light);">
    <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
      <input type="checkbox" id="repeatCheckbox"> ë°˜ë³µ
    </label>
    <div class="repeat-options-box" id="repeatOptions">
      <div class="repeat-option"><input type="radio" name="repeat" value="none" checked>âŒ</div>
      <div class="repeat-option"><input type="radio" name="repeat" value="daily">ë§¤ì¼</div>
      <div class="repeat-option"><input type="radio" name="repeat" value="weekly">ë§¤ì£¼</div>
      <div class="repeat-option"><input type="radio" name="repeat" value="monthly">ë§¤ë‹¬</div>
    </div>
  </div>
  <button id="saveEvent">ì €ì¥</button>
</div>

<div class="edit-popup" id="editPopup">
  <h3>ì¼ì • ìˆ˜ì •</h3>
  <input type="text" id="editInput" placeholder="ì¼ì • ë‚´ìš© ìˆ˜ì •">
  <div class="color-picker" id="editColorPicker"></div>
  <div style="display:flex;justify-content:center;gap:8px;align-items:center;">
    <label style="font-size:13px;color: var(--text-main);">ìš°ì„ ìˆœìœ„</label>
    <select id="editPrioritySelect" style="padding:6px;border-radius:8px;border:1px solid var(--border-color); background: var(--bg-light); color: var(--text-main);">
      <option value="high">ë†’ìŒ</option>
      <option value="medium">ë³´í†µ</option>
      <option value="low">ë‚®ìŒ</option>
    </select>
  </div>
  <div class="button-group">
    <button id="updateEvent">ìˆ˜ì •</button>
    <button id="cancelEdit" class="cancel-btn">ì·¨ì†Œ</button>
  </div>
</div>

<div class="view-popup" id="viewPopup">
  <h3>ì¼ì • í™•ì¸</h3>
  <div class="view-list" id="viewList"></div>
  <button id="closeView">ë‹«ê¸°</button>
</div>

<div class="stats-popup" id="statsPopup">
  <h3 id="statsTitle">ì›”ê°„ í†µê³„</h3>
  <div id="statsContent"></div>
  <div style="display:flex;gap:8px;margin-top:16px;">
    <button id="statsCloseBtn" class="cancel-btn" style="flex:1;">ë‹«ê¸°</button>
  </div>
</div>

<div class="popup" id="searchPopup" style="width:350px;">
  <h3>ì¼ì • ê²€ìƒ‰</h3>
  <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥...">
  <div class="search-results" id="searchResults"></div>
  <button id="searchCloseBtn" class="cancel-btn">ë‹«ê¸°</button>
</div>

<script>
const container = document.getElementById("calendarContainer");
const popup = document.getElementById("popup");
const editPopup = document.getElementById("editPopup");
const viewPopup = document.getElementById("viewPopup");
const overlay = document.getElementById("overlay");
const eventInput = document.getElementById("eventInput");
const editInput = document.getElementById("editInput");
const saveEventBtn = document.getElementById("saveEvent");
const updateEventBtn = document.getElementById("updateEvent");
const cancelEditBtn = document.getElementById("cancelEdit");
const colorPicker = document.getElementById("colorPicker");
const editColorPicker = document.getElementById("editColorPicker");
const viewList = document.getElementById("viewList");
const closeViewBtn = document.getElementById("closeView");

let today = new Date();
let currentMonth = today.getMonth();
let currentYear = today.getFullYear();
let selectedDate = null;
let selectedColor = "#ff4757";
let selectedPriority = 'medium';
let selectedRepeat = 'none';
let events = JSON.parse(localStorage.getItem("events")) || {};
let isAnimating = false;
let editingEvent = null;
let editingDateKey = null;
let carryCollapsed = localStorage.getItem('carryCollapsed') === 'true';

function createConfetti() {
  for(let i = 0; i < 100; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.top = '-10px';
    confetti.style.background = ['#ff6b6b', '#4a90e2', '#2ed573', '#ffa502', '#fffa65', '#5352ed'][Math.floor(Math.random() * 6)];
    confetti.style.animation = 'fall ' + (1.5 + Math.random() * 1.5) + 's linear';
    confetti.style.width = (5 + Math.random() * 15) + 'px';
    confetti.style.height = confetti.style.width;
    document.body.appendChild(confetti);
    setTimeout(function() { confetti.remove(); }, 3500);
  }
}

const style = document.createElement('style');
style.textContent = '@keyframes fall { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }';
document.head.appendChild(style);

let categoryVisibility = JSON.parse(localStorage.getItem("categoryVisibility")) || {
  "#ff4757": true,
  "#ffa502": true,
  "#2ed573": true,
  "#1e90ff": true,
  "#fffa65": true,
  "#5352ed": true
};

const colors = ["#ff4757", "#ffa502", "#fffa65", "#2ed573", "#1e90ff", "#5352ed"];
let categoryNames = JSON.parse(localStorage.getItem("categoryNames")) || {
  "#ff4757": "ì¹´í…Œê³ ë¦¬1",
  "#ffa502": "ì¹´í…Œê³ ë¦¬2",
  "#2ed573": "ì¹´í…Œê³ ë¦¬3",
  "#1e90ff": "ì¹´í…Œê³ ë¦¬4",
  "#fffa65": "ì¹´í…Œê³ ë¦¬5",
  "#5352ed": "ì¹´í…Œê³ ë¦¬6"
};

colors.forEach(c => {
  const div = document.createElement("div");
  div.className = "color-option";
  div.style.background = c;
  div.onclick = () => selectedColor = c;
  colorPicker.appendChild(div);
});

colors.forEach(c => {
  const div = document.createElement("div");
  div.className = "color-option";
  div.style.background = c;
  div.onclick = () => {
    if(editingEvent) editingEvent.color = c;
  };
  editColorPicker.appendChild(div);
});

function saveCategoryNames() {
  localStorage.setItem("categoryNames", JSON.stringify(categoryNames));
}

function saveCategoryVisibility() {
  localStorage.setItem("categoryVisibility", JSON.stringify(categoryVisibility));
}

function applyRepeatEvents() {
  const allEvents = JSON.parse(localStorage.getItem("events")) || {};
  const repeatData = JSON.parse(localStorage.getItem("repeatEvents")) || {};
  
  Object.keys(repeatData).forEach(function(baseDate) {
    const repeatType = repeatData[baseDate];
    if(repeatType === 'none') return;
    
    const baseEventsStr = allEvents[baseDate];
    if(!baseEventsStr) return;
    
    const [y, m, d] = baseDate.split('-').map(Number);
    const baseObj = new Date(y, m-1, d);
    
    for(let i = 1; i <= 365; i++) {
      let nextDate = new Date(baseObj);
      if(repeatType === 'daily') nextDate.setDate(nextDate.getDate() + i);
      else if(repeatType === 'weekly') nextDate.setDate(nextDate.getDate() + (7 * i));
      else if(repeatType === 'monthly') nextDate.setMonth(nextDate.getMonth() + i);
      else continue;
      
      if(nextDate > new Date(currentYear + 1, 11, 31)) break;
      
      const nextKey = nextDate.getFullYear() + "-" + String(nextDate.getMonth() + 1).padStart(2,"0") + "-" + String(nextDate.getDate()).padStart(2,"0");
      if(!allEvents[nextKey]) allEvents[nextKey] = [];
      
      const baseEvs = allEvents[baseDate];
      baseEvs.forEach(function(ev) {
        const exists = allEvents[nextKey].some(function(e) { return e.text === ev.text && e.isRepeated; });
        if(!exists) {
          allEvents[nextKey].push({text: ev.text, color: ev.color, completed: false, priority: ev.priority || 'medium', isRepeated: true});
        }
      });
    }
  });
  
  localStorage.setItem("events", JSON.stringify(allEvents));
}

function calculateStats(type) {
  const allEvents = events;
  let startDate, endDate, label;
  
  if(type === 'week') {
    const d = new Date();
    const first = d.getDate() - d.getDay();
    startDate = new Date(d.setDate(first));
    endDate = new Date(startDate);
    endDate.setDate(endDate.getDate() + 6);
    label = "ì£¼ê°„ í†µê³„";
  } else {
    startDate = new Date(currentYear, currentMonth, 1);
    endDate = new Date(currentYear, currentMonth + 1, 0);
    label = "ì›”ê°„ í†µê³„";
  }
  
  let totalEvents = 0, completedEvents = 0;
  const categoryStats = {};
  colors.forEach(function(c) { categoryStats[c] = {total: 0, completed: 0}; });
  
  for(let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
    const key = d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2,"0") + "-" + String(d.getDate()).padStart(2,"0");
    if(allEvents[key]) {
      allEvents[key].forEach(function(ev) {
        totalEvents++;
        if(ev.completed) completedEvents++;
        if(!categoryStats[ev.color]) categoryStats[ev.color] = {total: 0, completed: 0};
        categoryStats[ev.color].total++;
        if(ev.completed) categoryStats[ev.color].completed++;
      });
    }
  }
  
  const statsPopup = document.getElementById('statsPopup');
  const statsTitle = document.getElementById('statsTitle');
  const statsContent = document.getElementById('statsContent');
  
  statsTitle.textContent = label;
  statsContent.innerHTML = '';
  
  const totalItem = document.createElement('div');
  totalItem.className = 'stats-item';
  totalItem.innerHTML = '<span class="label">ì „ì²´ ì¼ì •</span><span class="value">' + totalEvents + 'ê°œ</span>';
  statsContent.appendChild(totalItem);
  
  const completeItem = document.createElement('div');
  completeItem.className = 'stats-item';
  const completeRate = totalEvents > 0 ? Math.round((completedEvents / totalEvents) * 100) : 0;
  completeItem.innerHTML = '<span class="label">ì™„ë£Œìœ¨</span><span class="value">' + completeRate + '%</span>';
  statsContent.appendChild(completeItem);
  
  colors.forEach(function(c) {
    if(categoryStats[c].total > 0) {
      const item = document.createElement('div');
      item.className = 'stats-item';
      const rate = Math.round((categoryStats[c].completed / categoryStats[c].total) * 100);
      item.innerHTML = '<span class="label" style="display:flex;align-items:center;gap:8px;"><span style="width:16px;height:16px;border-radius:50%;background:' + c + ';"></span>' + categoryNames[c] + '</span><span class="value">' + categoryStats[c].completed + '/' + categoryStats[c].total + ' (' + rate + '%)</span>';
      statsContent.appendChild(item);
    }
  });
  
  statsPopup.style.display = 'flex';
  overlay.style.display = 'block';
}

function searchEvents(query) {
  const searchResults = document.getElementById('searchResults');
  searchResults.innerHTML = '';
  
  if(!query.trim()) {
    searchResults.innerHTML = '<div style="padding:20px;text-align:center;color: var(--text-light);">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>';
    return;
  }
  
  const results = [];
  Object.keys(events).forEach(function(dateKey) {
    events[dateKey].forEach(function(ev) {
      if(ev.text.includes(query)) {
        results.push({dateKey: dateKey, event: ev});
      }
    });
  });
  
  if(results.length === 0) {
    searchResults.innerHTML = '<div style="padding:20px;text-align:center;color: var(--text-light);">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
  } else {
    results.forEach(function(r) {
      const item = document.createElement('div');
      item.className = 'search-result-item';
      item.style.borderLeftColor = r.event.color;
      item.innerHTML = '<div style="font-weight:bold;margin-bottom:4px;">' + r.event.text + '</div><div style="font-size:12px;color: var(--text-light);">' + r.dateKey + (r.event.completed ? ' (ì™„ë£Œ)' : '') + '</div>';
      item.onclick = function() {
        selectedDate = r.dateKey;
        document.getElementById('searchPopup').style.display = 'none';
        openViewPopup();
      };
      searchResults.appendChild(item);
    });
  }
}

function updateClock() {
  const dateTimeEl = document.querySelector('.date-time');
  if(dateTimeEl) {
    const now = new Date();
    const dateStr = now.getMonth() + 1 + "ì›” " + now.getDate() + "ì¼";
    const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    dateTimeEl.innerHTML = '<div>' + dateStr + '</div><div class="time">' + timeStr + '</div>';
  }
}

function renderTodayEvents() {
  const todayKey = currentYear + "-" + String(currentMonth + 1).padStart(2,"0") + "-" + String(today.getDate()).padStart(2,"0");
  const todayEventsList = document.getElementById("todayEventsList");

  if(!todayEventsList) return;

  todayEventsList.innerHTML = "";

  let completedCount = 0;
  let totalCount = 0;

  if(events[todayKey] && events[todayKey].length > 0) {
    totalCount = events[todayKey].length;
    completedCount = events[todayKey].filter(function(e) { return e.completed; }).length;

    const statsDiv = document.createElement("div");
    statsDiv.style.cssText = "font-size:13px;color: var(--text-light);padding:8px 0;text-align:center;border-bottom:1px solid var(--border-color);margin-bottom:8px;";
    statsDiv.textContent = "ì™„ë£Œí•œ ì¼ì •: " + completedCount + "/" + totalCount;
    todayEventsList.appendChild(statsDiv);

    events[todayKey].forEach(function(ev) {
      const item = document.createElement("div");
      item.className = "today-event-item";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.className = "today-event-checkbox";
      checkbox.checked = ev.completed || false;
      checkbox.onchange = function() {
        ev.completed = checkbox.checked;
        localStorage.setItem("events", JSON.stringify(events));
        renderTodayEvents();
        renderCalendar(0, false);
        checkAndMarkCompletedDays();
      };

      const dot = document.createElement("div");
      dot.className = "today-event-dot";
      dot.style.background = ev.color;

      const text = document.createElement("div");
      text.className = "today-event-text";
      if(ev.completed) text.classList.add("completed");
      text.textContent = ev.text;

      item.appendChild(checkbox);
      item.appendChild(dot);
      item.appendChild(text);
      todayEventsList.appendChild(item);
    });
  } else {
    const empty = document.createElement("div");
    empty.className = "today-empty";
    empty.textContent = "ì˜¤ëŠ˜ì˜ ì¼ì • ì—†ìŒ";
    todayEventsList.appendChild(empty);
  }

  // render carryover (past incomplete items)
  const carryoverList = document.getElementById("carryoverList");
  if(carryoverList) {
    carryoverList.innerHTML = "";
    const header = document.createElement('div');
    header.className = 'carryover-header';
    const title = document.createElement('div');
    title.textContent = 'âŸ² ë¯¸ì™„ë£Œ ê³¼ì œ';
    const toggle = document.createElement('button');
    toggle.textContent = carryCollapsed ? 'í¼ì¹˜ê¸°' : 'ì ‘ê¸°';
    toggle.onclick = function(e) { 
      e.stopPropagation(); 
      carryCollapsed = !carryCollapsed; 
      localStorage.setItem('carryCollapsed', carryCollapsed); 
      renderTodayEvents(); 
    };
    header.appendChild(title);
    header.appendChild(toggle);
    carryoverList.appendChild(header);

    if(!carryCollapsed) {
      const items = [];
      Object.keys(events).forEach(function(k) {
        if(k < todayKey) {
          events[k].forEach(function(ev) {
            if(!ev.completed) { items.push({dateKey: k, ev: ev}); }
          });
        }
      });

      const prioMap = { 'high': 3, 'medium': 2, 'low': 1 };
      items.sort(function(a, b) {
        const pa = prioMap[a.ev.priority || 'medium'];
        const pb = prioMap[b.ev.priority || 'medium'];
        if(pb !== pa) return pb - pa;
        if(a.dateKey !== b.dateKey) return a.dateKey < b.dateKey ? -1 : 1;
        return 0;
      });

      if(items.length === 0) {
        const p = document.createElement('div');
        p.style.cssText = 'padding:8px;color: var(--text-light);font-size:13px;';
        p.textContent = 'ë¯¸ì™„ë£Œ ê³¼ì œ ì—†ìŒ';
        carryoverList.appendChild(p);
      }

      items.forEach(function(it) {
        const ev = it.ev;
        const item = document.createElement('div');
        item.className = 'today-event-item';
        item.style.background = '#fff7f0';
        item.style.borderLeft = '4px solid #ffb86b';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'today-event-checkbox';
        checkbox.checked = ev.completed || false;
        checkbox.onchange = function() {
          ev.completed = checkbox.checked;
          localStorage.setItem('events', JSON.stringify(events));
          renderTodayEvents();
          renderCalendar(0, false);
        };

        const dot = document.createElement('div');
        dot.className = 'today-event-dot';
        dot.style.background = ev.color;

        const text = document.createElement('div');
        text.className = 'today-event-text';
        if(ev.completed) text.classList.add('completed');
        text.textContent = '(' + it.dateKey + ') ' + ev.text;

        const pr = document.createElement('div');
        pr.style.cssText = 'font-size:12px;color: var(--text-light);';
        pr.textContent = ev.priority ? (ev.priority === 'high' ? 'ë†’ìŒ' : ev.priority === 'medium' ? 'ë³´í†µ' : 'ë‚®ìŒ') : 'ë³´í†µ';

        const moveBtn = document.createElement('button');
        moveBtn.textContent = 'ì˜¤ëŠ˜ë¡œ';
        moveBtn.style.padding = '6px 8px';
        moveBtn.style.fontSize = '12px';
        moveBtn.onclick = function(e) {
          e.stopPropagation();
          if(!events[todayKey]) events[todayKey] = [];
          events[todayKey].push({text: ev.text, color: ev.color, completed: false, priority: ev.priority || 'medium'});
          ev.completed = true;
          localStorage.setItem('events', JSON.stringify(events));
          renderTodayEvents();
          renderCalendar(0, false);
          checkAndMarkCompletedDays();
        };

        const delBtn = document.createElement('button');
        delBtn.textContent = 'âœ•';
        delBtn.style.padding = '6px 8px';
        delBtn.style.fontSize = '12px';
        delBtn.style.background = '#ff6b6b';
        delBtn.style.marginLeft = '4px';
        delBtn.onclick = function(e) {
          e.stopPropagation();
          if(confirm('"' + ev.text + '" ì‚­ì œí• ê¹Œìš”?')) {
            events[it.dateKey] = events[it.dateKey].filter(function(x) { return x !== ev; });
            if(!events[it.dateKey].length) delete events[it.dateKey];
            localStorage.setItem('events', JSON.stringify(events));
            renderTodayEvents();
            renderCalendar(0, false);
            checkAndMarkCompletedDays();
          }
        };

        item.appendChild(checkbox);
        item.appendChild(dot);
        item.appendChild(text);
        item.appendChild(pr);
        item.appendChild(moveBtn);
        item.appendChild(delBtn);
        carryoverList.appendChild(item);
      });
    } else {
      const hint = document.createElement('div');
      hint.style.cssText = 'padding:8px;color: var(--text-light);font-size:13px;';
      hint.textContent = 'ë¯¸ì™„ë£Œ í•­ëª© ìˆ¨ê¹€(í´ë¦­í•˜ë©´ í¼ì³ì§‘ë‹ˆë‹¤)';
      carryoverList.appendChild(hint);
    }
  }
}

function checkAndMarkCompletedDays() {
  Object.keys(events).forEach(function(dateKey) {
    const dayEvents = events[dateKey];
    if(dayEvents && dayEvents.length > 0) {
      const allCompleted = dayEvents.every(function(e) { return e.completed; });
      const dayEl = document.querySelector('[data-date="' + dateKey + '"]');
      if(dayEl) {
        if(allCompleted) {
          dayEl.classList.add('completed-day');
        } else {
          dayEl.classList.remove('completed-day');
        }
      }
    }
  });
}

function renderCalendar(direction, animate) {
  direction = direction || 0;
  animate = animate !== undefined ? animate : true;
  
  const title = document.querySelector('.calendar-header h2');
  if(title) title.textContent = currentYear + "ë…„ " + (currentMonth + 1) + "ì›”";

  const newCal = document.createElement("div");
  newCal.className = "calendar-grid";
  newCal.style.left = direction > 0 ? "100%" : direction < 0 ? "-100%" : "0";

  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();

  ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "].forEach(function(d) {
    const div = document.createElement("div");
    div.className = "day-header";
    div.textContent = d;
    newCal.appendChild(div);
  });

  const prevLastDate = new Date(currentYear, currentMonth, 0).getDate();
  for(let i = firstDay - 1; i >= 0; i--) {
    const prevDate = prevLastDate - i;
    const dateObj = new Date(currentYear, currentMonth - 1, prevDate);
    const dateKey = dateObj.getFullYear() + "-" + String(dateObj.getMonth()+1).padStart(2,"0") + "-" + String(dateObj.getDate()).padStart(2,"0");
    createDayDiv(newCal, dateObj, dateKey, true);
  }

  for(let d = 1; d <= lastDate; d++) {
    const dateObj = new Date(currentYear, currentMonth, d);
    const dateKey = currentYear + "-" + String(currentMonth + 1).padStart(2,"0") + "-" + String(d).padStart(2,"0");
    createDayDiv(newCal, dateObj, dateKey, false);
  }

  let totalCells = firstDay + lastDate;
  let nextCount = 7 - (totalCells % 7);
  if(nextCount < 7) {
    for(let i = 1; i <= nextCount; i++) {
      const dateObj = new Date(currentYear, currentMonth + 1, i);
      const dateKey = dateObj.getFullYear() + "-" + String(dateObj.getMonth()+1).padStart(2,"0") + "-" + String(dateObj.getDate()).padStart(2,"0");
      createDayDiv(newCal, dateObj, dateKey, true);
    }
  }

  const mainEl = document.querySelector('.calendar-main');
  const oldCal = document.querySelector('.calendar-grid');

  if(direction === 0 || !animate || !oldCal) {
    if(oldCal) oldCal.replaceWith(newCal);
    else mainEl.appendChild(newCal);
    checkAndMarkCompletedDays();
    return;
  }

  if(isAnimating) return;
  isAnimating = true;
  mainEl.appendChild(newCal);

  requestAnimationFrame(function() {
    newCal.style.left = "0";
    oldCal.style.left = direction > 0 ? "-100%" : "100%";
  });

  newCal.addEventListener("transitionend", function() {
    oldCal.remove();
    isAnimating = false;
    checkAndMarkCompletedDays();
  }, {once: true});
}

function createDayDiv(container, dateObj, dateKey, isOtherMonth) {
  const div = document.createElement("div");
  div.className = "day";
  div.setAttribute('data-date', dateKey);
  if(isOtherMonth) div.classList.add('other');

  const num = document.createElement("div");
  num.className = "day-number";
  num.textContent = dateObj.getDate();
  div.appendChild(num);

  const dotBox = document.createElement("div");
  dotBox.className = "dots";

  if(events[dateKey]) {
    events[dateKey].forEach(function(ev) {
      const dot = document.createElement("div");
      dot.className = "dot";
      dot.style.background = ev.color;
      dot.style.cursor = "pointer";
      dot.title = ev.text + (ev.completed ? " (ì™„ë£Œ)" : "");
      if(ev.completed) dot.style.opacity = "0.45";
      dot.style.display = categoryVisibility[ev.color] !== false ? 'block' : 'none';

      dot.oncontextmenu = function(e) {
        e.preventDefault();
        openEditPopup(ev, dateKey);
      };

      dot.ondblclick = function(e) {
        e.stopPropagation();
        if(confirm('"' + ev.text + '" ì‚­ì œí• ê¹Œìš”?')) {
          events[dateKey] = events[dateKey].filter(function(x) { return x !== ev; });
          if(!events[dateKey].length) delete events[dateKey];
          localStorage.setItem("events", JSON.stringify(events));
          renderCalendar(0, false);
          renderTodayEvents();
        }
      };

      dotBox.appendChild(dot);
    });
  }
  div.appendChild(dotBox);

  if(!isOtherMonth && dateObj.getFullYear() === today.getFullYear() && dateObj.getMonth() === today.getMonth() && dateObj.getDate() === today.getDate()) {
    div.classList.add("today");
  }
  
  // Check if all events on this day are completed
  if(events[dateKey] && events[dateKey].length > 0) {
    const allCompleted = events[dateKey].every(function(e) { return e.completed; });
    if(allCompleted) {
      div.classList.add('completed-day');
    }
  }

  div.onclick = function() {
    if(!isOtherMonth) {
      selectedDate = dateKey;
      openPopup();
    }
  };

  div.oncontextmenu = function(e) {
    e.preventDefault();
    if(!isOtherMonth) {
      selectedDate = dateKey;
      openViewPopup();
    }
  };

  container.appendChild(div);
}

function openPopup() {
  popup.style.display = "flex";
  overlay.style.display = "block";
  eventInput.value = "";
  eventInput.focus();
}

function closePopup() {
  popup.style.display = "none";
  overlay.style.display = "none";
}

function openEditPopup(ev, dateKey) {
  editingEvent = ev;
  editingDateKey = dateKey;
  editInput.value = ev.text;
  const editPrioritySelectEl = document.getElementById('editPrioritySelect');
  if(editPrioritySelectEl) editPrioritySelectEl.value = ev.priority || 'medium';
  editPopup.style.display = "flex";
  overlay.style.display = "block";
  editInput.focus();
}

function closeEditPopup() {
  editPopup.style.display = "none";
  overlay.style.display = "none";
  editingEvent = null;
  editingDateKey = null;
}

function openViewPopup() {
  viewList.innerHTML = "";
  if(events[selectedDate]) {
    events[selectedDate].forEach(function(ev) {
      const div = document.createElement("div");
      div.className = "view-item";

      const dot = document.createElement("div");
      dot.className = "view-dot";
      dot.style.background = ev.color;

      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.checked = !!ev.completed;
      chk.onchange = function() {
        ev.completed = chk.checked;
        localStorage.setItem("events", JSON.stringify(events));
        renderCalendar(0, false);
        renderTodayEvents();
        checkAndMarkCompletedDays();
        openViewPopup();
      };

      const text = document.createElement("div");
      text.className = "view-text";
      text.textContent = ev.text;
      if(ev.completed) text.style.textDecoration = 'line-through';

      const delBtn = document.createElement("button");
      delBtn.textContent = "âœ•";
      delBtn.onclick = function() {
        events[selectedDate] = events[selectedDate].filter(function(x) { return x !== ev; });
        if(!events[selectedDate].length) delete events[selectedDate];
        localStorage.setItem("events", JSON.stringify(events));
        renderCalendar(0, false);
        renderTodayEvents();
        checkAndMarkCompletedDays();
        openViewPopup();
      };

      div.appendChild(dot);
      div.appendChild(chk);
      div.appendChild(text);
      div.appendChild(delBtn);
      viewList.appendChild(div);
    });
  } else {
    const p = document.createElement("div");
    p.textContent = "ì¼ì • ì—†ìŒ";
    viewList.appendChild(p);
  }
  viewPopup.style.display = "flex";
  overlay.style.display = "block";
}

function closeViewPopup() {
  viewPopup.style.display = "none";
  overlay.style.display = "none";
}

saveEventBtn.onclick = function() {
  if(!selectedDate) return;
  const text = eventInput.value.trim();
  if(text) {
    if(!events[selectedDate]) events[selectedDate] = [];
    events[selectedDate].push({text: text, color: selectedColor, completed: false, priority: selectedPriority});
    localStorage.setItem("events", JSON.stringify(events));
    
    // Save repeat data if checked
    const repeatCheckbox = document.getElementById('repeatCheckbox');
    if(repeatCheckbox && repeatCheckbox.checked) {
      const repeatRadios = document.querySelectorAll('input[name="repeat"]');
      let repeatType = 'none';
      repeatRadios.forEach(function(r) { if(r.checked) repeatType = r.value; });
      
      let repeatData = JSON.parse(localStorage.getItem("repeatEvents")) || {};
      repeatData[selectedDate] = repeatType;
      localStorage.setItem("repeatEvents", JSON.stringify(repeatData));
      applyRepeatEvents();
    }
    
    renderCalendar(0, false);
    renderTodayEvents();
    checkAndMarkCompletedDays();
  }
  closePopup();
};

updateEventBtn.onclick = function() {
  if(!editingEvent || !editingDateKey) return;
  const text = editInput.value.trim();
  const editPrioritySelectEl = document.getElementById('editPrioritySelect');
  const newPriority = editPrioritySelectEl ? editPrioritySelectEl.value : (editingEvent.priority || 'medium');
  if(text) {
    editingEvent.text = text;
    editingEvent.priority = newPriority;
    localStorage.setItem("events", JSON.stringify(events));
    renderCalendar(0, false);
    renderTodayEvents();
    checkAndMarkCompletedDays();
  }
  closeEditPopup();
};

cancelEditBtn.onclick = closeEditPopup;
closeViewBtn.onclick = closeViewPopup;

overlay.onclick = function() {
  closePopup();
  closeEditPopup();
  closeViewPopup();
};

function changeMonth(delta) {
  if(isAnimating) return;
  currentMonth += delta;
  if(currentMonth < 0) { currentMonth = 11; currentYear--; }
  if(currentMonth > 11) { currentMonth = 0; currentYear++; }
  renderCalendar(delta, true);
}

function goToday() {
  if(isAnimating) return;
  let monthsDiff = (today.getFullYear() - currentYear) * 12 + (today.getMonth() - currentMonth);
  if(monthsDiff === 0) return;
  let step = monthsDiff > 0 ? 1 : -1;

  function slideNext() {
    if(currentYear === today.getFullYear() && currentMonth === today.getMonth()) return;
    if(isAnimating) return;
    currentMonth += step;
    if(currentMonth < 0) { currentMonth = 11; currentYear--; }
    if(currentMonth > 11) { currentMonth = 0; currentYear++; }
    renderCalendar(step, true);
    setTimeout(function() { slideNext(); }, 400);
  }
  slideNext();
}

const fileInput = document.createElement("input");
fileInput.type = "file";
fileInput.accept = ".json";
fileInput.style.display = "none";
fileInput.onchange = function(e) {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(event) {
    try {
      const imported = JSON.parse(event.target.result);
      if(imported.events && typeof imported.events === "object") {
        events = imported.events;
        if(imported.categoryNames) categoryNames = Object.assign({}, categoryNames, imported.categoryNames);
        if(imported.categoryVisibility) categoryVisibility = Object.assign({}, categoryVisibility, imported.categoryVisibility);
        localStorage.setItem("events", JSON.stringify(events));
        localStorage.setItem("categoryNames", JSON.stringify(categoryNames));
        localStorage.setItem("categoryVisibility", JSON.stringify(categoryVisibility));
        renderCalendar(0, false);
        renderTodayEvents();
        alert("âœ… ì¼ì •ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!");
      } else if(typeof imported === "object" && imported !== null && !imported.events) {
        events = imported;
        localStorage.setItem("events", JSON.stringify(events));
        renderCalendar(0, false);
        renderTodayEvents();
        alert("âœ… ì¼ì •ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!");
      } else {
        alert("âŒ ì˜ëª»ëœ íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.");
      }
    } catch(err) {
      alert("âŒ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + err.message);
    }
  };
  reader.readAsText(file);
};
document.body.appendChild(fileInput);

function exportEvents() {
  const data = JSON.stringify({
    events: events,
    categoryNames: categoryNames,
    categoryVisibility: categoryVisibility
  }, null, 2);
  const blob = new Blob([data], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "calendar_" + new Date().toISOString().split("T")[0] + ".json";
  a.click();
  URL.revokeObjectURL(url);
  alert("âœ… ì¼ì •ì´ ë‚´ë³´ë‚´ê¸° ë˜ì—ˆìŠµë‹ˆë‹¤!");
}

function importEvents() {
  fileInput.click();
}

function toggleDark() {
  document.body.classList.toggle('dark-mode');
  localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
}

if(localStorage.getItem('darkMode') === 'true') {
  document.body.classList.add('dark-mode');
}

// Setup header
const header = document.createElement("div");
header.className = "calendar-header";

const prevBtn = document.createElement("button");
prevBtn.textContent = "â—€";
prevBtn.onclick = function() { changeMonth(-1); };

const title = document.createElement("h2");

const nextBtn = document.createElement("button");
nextBtn.textContent = "â–¶";
nextBtn.onclick = function() { changeMonth(1); };

const todayBtn = document.createElement("button");
todayBtn.textContent = "ì˜¤ëŠ˜";
todayBtn.onclick = goToday;

const exportBtn = document.createElement("button");
exportBtn.textContent = "â¬‡ï¸ ë‚´ë³´ë‚´ê¸°";
exportBtn.onclick = exportEvents;

const importBtn = document.createElement("button");
importBtn.textContent = "â¬†ï¸ ê°€ì ¸ì˜¤ê¸°";
importBtn.onclick = importEvents;

const darkBtn = document.createElement("button");
darkBtn.textContent = document.body.classList.contains('dark-mode') ? "â˜€ï¸ ë¼ì´íŠ¸" : "ğŸŒ™ ë‹¤í¬";
darkBtn.onclick = function() {
  toggleDark();
  darkBtn.textContent = document.body.classList.contains('dark-mode') ? "â˜€ï¸ ë¼ì´íŠ¸" : "ğŸŒ™ ë‹¤í¬";
};

const statsBtn = document.createElement("button");
statsBtn.textContent = "ğŸ“Š í†µê³„";
statsBtn.onclick = function() { calculateStats('month'); };

const searchBtn = document.createElement("button");
searchBtn.textContent = "ğŸ” ê²€ìƒ‰";
searchBtn.onclick = function() { 
  document.getElementById('searchPopup').style.display = 'flex';
  overlay.style.display = 'block';
  document.getElementById('searchInput').focus();
};

const dateTime = document.createElement("div");
dateTime.className = "date-time";

const btnGroup = document.createElement("div");
btnGroup.className = "header-buttons";
btnGroup.appendChild(prevBtn);
btnGroup.appendChild(nextBtn);
btnGroup.appendChild(todayBtn);
btnGroup.appendChild(statsBtn);
btnGroup.appendChild(searchBtn);
btnGroup.appendChild(exportBtn);
btnGroup.appendChild(importBtn);
btnGroup.appendChild(darkBtn);

header.appendChild(btnGroup);
header.appendChild(title);
header.appendChild(dateTime);
container.appendChild(header);

// Setup content area
const content = document.createElement("div");
content.className = "calendar-content";

const mainDiv = document.createElement("div");
mainDiv.className = "calendar-main";
mainDiv.style.minWidth = '400px';

const resizer = document.createElement('div');
resizer.className = 'resizer';

const sidebar = document.createElement("div");
sidebar.className = "today-sidebar";
sidebar.style.width = localStorage.getItem('sidebarWidth') || '320px';

content.appendChild(mainDiv);
content.appendChild(resizer);
content.appendChild(sidebar);

const sidebarHeader = document.createElement("div");
sidebarHeader.className = "today-header";
sidebarHeader.innerHTML = "<h3>ğŸ“‹ ì˜¤ëŠ˜ì˜ ì¼ì •</h3><div class='today-date'></div>";
sidebar.appendChild(sidebarHeader);

// incomplete list (carryover)
const carryoverBox = document.createElement('div');
carryoverBox.id = 'carryoverList';
carryoverBox.style.cssText = 'padding:8px;overflow:auto;border-bottom:1px solid var(--border-color);max-height:220px;';
sidebar.appendChild(carryoverBox);

const sidebarEvents = document.createElement("div");
sidebarEvents.id = "todayEventsList";
sidebarEvents.className = "today-events";
sidebar.appendChild(sidebarEvents);

const legendBox = document.createElement("div");
legendBox.className = "legend";
colors.forEach(function(color) {
  const item = document.createElement("div");
  item.className = "legend-item";

  const checkbox = document.createElement("input");
  checkbox.type = "checkbox";
  checkbox.checked = categoryVisibility[color] !== false;
  checkbox.onchange = function() {
    categoryVisibility[color] = checkbox.checked;
    saveCategoryVisibility();
    renderCalendar(0, false);
  };

  const dot = document.createElement("div");
  dot.className = "legend-dot";
  dot.style.background = color;

  const nameSpan = document.createElement("span");
  nameSpan.className = "category-name";
  nameSpan.textContent = categoryNames[color];
  nameSpan.style.cursor = "pointer";
  nameSpan.style.minWidth = "60px";

  nameSpan.onclick = function() {
    const newName = prompt("ì¹´í…Œê³ ë¦¬ëª… ë³€ê²½:", categoryNames[color]);
    if(newName && newName.trim()) {
      categoryNames[color] = newName.trim();
      saveCategoryNames();
      nameSpan.textContent = categoryNames[color];
    }
  };

  item.appendChild(checkbox);
  item.appendChild(dot);
  item.appendChild(nameSpan);
  legendBox.appendChild(item);
});
sidebar.appendChild(legendBox);

content.appendChild(sidebar);
container.appendChild(content);

// Resizer drag logic
(function() {
  const res = document.querySelector('.resizer');
  const main = document.querySelector('.calendar-main');
  const side = document.querySelector('.today-sidebar');
  if(!res || !main || !side) return;
  let isResizing = false;
  let startX = 0;
  let startMainW = 0;
  let startSideW = 0;
  const minMain = 400;
  const minSide = 200;

  function startResize(e) {
    isResizing = true;
    startX = e.type.indexOf('touch') > -1 ? e.touches[0].clientX : e.clientX;
    startMainW = main.getBoundingClientRect().width;
    startSideW = side.getBoundingClientRect().width;
    document.body.style.userSelect = 'none';
    res.classList.add('active');
    e.preventDefault();
  }

  function updateResize(e) {
    if(!isResizing) return;
    const currentX = e.type.indexOf('touch') > -1 ? e.touches[0].clientX : e.clientX;
    const dx = currentX - startX;
    let newMain = startMainW + dx;
    let newSide = startSideW - dx;
    if(newMain < minMain) { newMain = minMain; newSide = startMainW + startSideW - minMain; }
    if(newSide < minSide) { newSide = minSide; newMain = startMainW + startSideW - minSide; }
    main.style.flex = "0 0 " + newMain + "px";
    side.style.flex = "0 0 " + newSide + "px";
    side.style.width = newSide + "px";
    e.preventDefault();
  }

  function endResize() {
    if(isResizing) {
      isResizing = false;
      document.body.style.userSelect = '';
      res.classList.remove('active');
      const finalW = document.querySelector('.today-sidebar').getBoundingClientRect().width;
      localStorage.setItem('sidebarWidth', Math.round(finalW) + 'px');
    }
  }

  res.addEventListener('mousedown', startResize);
  document.addEventListener('mousemove', updateResize);
  document.addEventListener('mouseup', endResize);

  res.addEventListener('touchstart', startResize);
  document.addEventListener('touchmove', updateResize);
  document.addEventListener('touchend', endResize);
})();

// Swipe to change month
(function() {
  let startX = 0, startY = 0;
  const main = document.querySelector('.calendar-main');
  if(!main) return;
  main.addEventListener('touchstart', function(e) {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
  });
  main.addEventListener('touchend', function(e) {
    const endX = e.changedTouches[0].clientX;
    const endY = e.changedTouches[0].clientY;
    const dx = endX - startX;
    const dy = endY - startY;
    if(Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 50) {
      changeMonth(dx > 0 ? -1 : 1);
    }
  });
})();

// Pinch zoom
(function() {
  let dist = 0, scale = 1;
  const grid = document.querySelector('.calendar-grid');
  if(!grid) return;
  function getDist(t) {
    const dx = t[0].clientX - t[1].clientX;
    const dy = t[0].clientY - t[1].clientY;
    return Math.sqrt(dx*dx + dy*dy);
  }
  grid.addEventListener('touchstart', function(e) {
    if(e.touches.length === 2) {
      dist = getDist(e.touches);
      const s = grid.style.transform;
      const m = s.match(/scale\(([^)]+)\)/);
      scale = m ? parseFloat(m[1]) : 1;
    }
  });
  grid.addEventListener('touchmove', function(e) {
    if(e.touches.length === 2) {
      e.preventDefault();
      const d = getDist(e.touches);
      let z = scale * (d / dist);
      z = Math.max(0.8, Math.min(1.3, z));
      grid.style.transform = 'scale(' + z + ')';
      grid.style.transformOrigin = '50% 50%';
    }
  });
  grid.addEventListener('touchend', function(e) {
    if(e.touches.length < 2) {
      const s = grid.style.transform;
      const m = s.match(/scale\(([^)]+)\)/);
      const z = m ? parseFloat(m[1]) : 1;
      localStorage.setItem('calendarZoom', z);
    }
  });
  const saved = parseFloat(localStorage.getItem('calendarZoom') || 1);
  if(saved !== 1) grid.style.transform = 'scale(' + saved + ')';
})();

const prioritySelect = document.getElementById('prioritySelect');
if(prioritySelect) prioritySelect.onchange = function() { selectedPriority = prioritySelect.value; };

// Repeat checkbox event
const repeatCheckbox = document.getElementById('repeatCheckbox');
const repeatOptions = document.getElementById('repeatOptions');
if(repeatCheckbox) {
  repeatCheckbox.onchange = function() {
    if(repeatCheckbox.checked) {
      repeatOptions.style.display = 'block';
    } else {
      repeatOptions.style.display = 'none';
    }
  };
}

// Search popup events
const searchInput = document.getElementById('searchInput');
const searchCloseBtn = document.getElementById('searchCloseBtn');
if(searchInput) {
  searchInput.onkeyup = function() { searchEvents(searchInput.value); };
}
if(searchCloseBtn) {
  searchCloseBtn.onclick = function() {
    document.getElementById('searchPopup').style.display = 'none';
    overlay.style.display = 'none';
  };
}

// Stats popup close
const statsCloseBtn = document.getElementById('statsCloseBtn');
if(statsCloseBtn) {
  statsCloseBtn.onclick = function() {
    document.getElementById('statsPopup').style.display = 'none';
    overlay.style.display = 'none';
  };
}

updateClock();
setInterval(updateClock, 1000);

const sidebarDate = document.querySelector(".today-header .today-date");
setInterval(function() {
  const now = new Date();
  if(sidebarDate) sidebarDate.textContent = now.getMonth() + 1 + "ì›” " + now.getDate() + "ì¼";
}, 1000);

renderCalendar();
renderTodayEvents();
applyRepeatEvents();
setTimeout(checkAndMarkCompletedDays, 100);
</script>
</body>
</html>
